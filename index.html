<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Keluarga Realtime</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #e5ddd5; }
        #login-screen { margin: auto; text-align: center; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #chat-app { display: none; width: 100%; }
        #sidebar { width: 30%; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #chat-window { width: 70%; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 8px; max-width: 70%; }
        .msg.me { align-self: flex-end; background: #dcf8c6; }
        .msg.them { align-self: flex-start; background: #fff; }
        #input-area { padding: 10px; background: #f0f0f0; display: flex; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px; cursor: pointer; border: none; background: #075e54; color: white; border-radius: 5px; margin-left: 5px; }
        .contact-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .contact-item:hover { background: #f9f9f9; }
        .status-bar { padding: 10px; font-size: 12px; background: #eee; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
<div id="login-screen">
    <h2>Chat Keluarga</h2>
    <button onclick="login()" style="background: #4285f4; font-size: 16px;">Login dengan Google</button>
</div>
<div id="chat-app">
    <div id="sidebar">
        <div class="status-bar">
            <span id="user-name">Memuat...</span>
            <button onclick="logout()" style="background: #cc0000; padding: 3px 8px;">Keluar</button>
        </div>
        <div style="padding: 10px;">
            <button onclick="subscribeNotif()" id="notif-btn" style="width: 100%; background: #075e54;">ðŸ”” Aktifkan Notifikasi</button>
            <hr>
            <input type="text" id="new-contact-email" placeholder="Email keluarga...">
            <button onclick="tambahKontak()" style="width: 100%; margin: 5px 0;">Tambah Kontak</button>
        </div>
        <div id="contact-list"></div>
    </div>
    <div id="chat-window">
        <div id="messages">Pilih kontak untuk mulai chat</div>
        <div id="input-area" style="display: none;">
            <input type="text" id="msg-input" placeholder="Ketik pesan...">
            <button onclick="kirimPesan()">Kirim</button>
        </div>
    </div>
</div>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDPRX2nyEeLJsmXgwahVoo48tH4qNgR-QA",
        authDomain: "chat-ef550.firebaseapp.com",
        databaseURL: "https://chat-ef550-default-rtdb.firebaseio.com",
        projectId: "chat-ef550",
        storageBucket: "chat-ef550.firebasestorage.app",
        messagingSenderId: "126809001422",
        appId: "1:126809001422:web:73c0acc196642f1adf6f9f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser = null;
    let activeChatUser = null;
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
            appId: "80fae3f0-8acb-402c-b426-74cdc90d39ff",
            serviceWorkerPath: "mychat/OneSignalSDKWorker.js",
            serviceWorkerParam: { scope: "/mychat/" }
        });
    });
    function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
    }
    function logout() {
        auth.signOut().then(() => location.reload());
    }
    function subscribeNotif() {
        OneSignalDeferred.push(function(OneSignal) {
            OneSignal.Notifications.requestPermission();
        });
    }
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-app').style.display = 'flex';
            document.getElementById('user-name').innerText = user.displayName;
            OneSignalDeferred.push(function(OneSignal) {
                OneSignal.login(user.uid);
            });
            db.ref('users/' + user.uid).update({
                name: user.displayName,
                email: user.email,
                photo: user.photoURL
            });
            muatKontak();
        }
    });
    function tambahKontak() {
        const email = document.getElementById('new-contact-email').value;
        db.ref('users').orderByChild('email').equalTo(email).once('value', snapshot => {
            if (snapshot.exists()) {
                const targetUid = Object.keys(snapshot.val())[0];
                db.ref(`users/${currentUser.uid}/contacts/${targetUid}`).set(true);
                alert("Kontak ditambahkan!");
            } else {
                alert("User tidak ditemukan.");
            }
        });
    }
    function muatKontak() {
        db.ref(`users/${currentUser.uid}/contacts`).on('value', snapshot => {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            snapshot.forEach(child => {
                db.ref(`users/${child.key}`).once('value', u => {
                    const div = document.createElement('div');
                    div.className = 'contact-item';
                    div.innerText = u.val().name;
                    div.onclick = () => bukaChat(child.key, u.val().name);
                    list.appendChild(div);
                });
            });
        });
    }
    function bukaChat(uid, name) {
        activeChatUser = uid;
        document.getElementById('messages').innerHTML = `Memuat chat dengan ${name}...`;
        document.getElementById('input-area').style.display = 'flex';
        const chatID = [currentUser.uid, uid].sort().join('_');
        db.ref(`messages/${chatID}`).on('value', snapshot => {
            const msgDiv = document.getElementById('messages');
            msgDiv.innerHTML = '';
            snapshot.forEach(child => {
                const data = child.val();
                const div = document.createElement('div');
                div.className = `msg ${data.sender === currentUser.uid ? 'me' : 'them'}`;
                div.innerText = data.text;
                msgDiv.appendChild(div);
            });
            msgDiv.scrollTop = msgDiv.scrollHeight;
        });
    }
    async function kirimPesan() {
        const text = document.getElementById('msg-input').value;
        if (!text || !activeChatUser) return;
        const chatID = [currentUser.uid, activeChatUser].sort().join('_');
        db.ref(`messages/${chatID}`).push({
            sender: currentUser.uid,
            text: text,
            timestamp: Date.now()
        });
        document.getElementById('msg-input').value = '';
        fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "Authorization": "Basic os_v2_app_qd5oh4ekznacznbgotg4sdjz7752fu664f7euj47kspk2z3r7llcdvi7qhjmn4jkqo4lbdtpqsck4eqp3ebbqyhofbnkba7mv4ppqka"
            },
            body: JSON.stringify({
                app_id: "80fae3f0-8acb-402c-b426-74cdc90d39ff",
                include_external_user_ids: [activeChatUser],
                headings: {"en": currentUser.displayName},
                contents: {"en": text},
                url: window.location.origin
            })
        });
    }
</script>
</body>
</html>
